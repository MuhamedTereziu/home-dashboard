<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Termux Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#0f1220;--card:#171a2b;--text:#e7e9f3;--muted:#a7acc0;--accent-2:#4f6af5;--accent-3:#f59f4f;--ok:#3ddc97;--bad:#ef4444;--border:rgba(255,255,255,.08)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:radial-gradient(1200px 800px at 20% -10%, #1a1e33 0%, var(--bg) 60%)}
    .container{max-width:1200px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:22px}
    .chips{display:flex;gap:8px}
    .chip{background:#1e2235;padding:6px 10px;border-radius:999px;color:var(--muted);border:1px solid var(--border);font-size:12px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 60%),var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:15px}
    .sub{color:var(--muted);font-size:13px} 
    .span-3{grid-column:span 3}.span-6{grid-column:span 6}.span-8{grid-column:span 8}.span-12{grid-column:span 12}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .kpi{background:#121527;border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-size:13px;color:var(--muted)}
    .kpi strong{color:var(--text)}
    .wifi-bars{display:flex;align-items:end;gap:4px;height:24px}
    .wifi-bar{width:8px;background:#4f6af5;border-radius:2px;opacity:.3}
    .wifi-bar:nth-child(1){height:6px}.wifi-bar:nth-child(2){height:10px}.wifi-bar:nth-child(3){height:16px}.wifi-bar:nth-child(4){height:22px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text);text-align:left}
    .table th{color:var(--muted)}
    .controls button, button{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#121527;color:var(--text);cursor:pointer}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .badge.bad{background:#2a1214;color:#ffb4b4;border-color:#5c1f25}
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
    pre{background:#0c0e16;padding:8px;border-radius:8px;border:1px solid var(--border);color:var(--muted);font-size:13px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Termux Dashboard</h1>
      <div class="chips">
        <div class="chip"><a href="https://mikrotik.mtereziu.xyz/webfig/" style="color:inherit;text-decoration:none">üåê Router config</a></div>
    </header>

    <section class="grid">
      <!-- Battery -->
      <div class="card span-3">
        <h2>Battery</h2>
        <div class="row">
          <div class="kpi">Level: <strong id="battery-percent">‚Äî%</strong></div>
          <div class="kpi">Status: <strong id="charging-status">‚Äî</strong></div>
        </div>
        <div class="row">
          <div class="kpi">Temp: <strong id="bat-temp">‚Äî</strong> ¬∞C</div>
        </div>
      </div>

      <!-- System -->
      <div class="card span-3">
        <h2>System</h2>
        <div class="row">
          <div class="kpi">Uptime: <strong id="sys-uptime">‚Äî</strong></div>
          <div class="kpi">Load: <strong id="sys-load">‚Äî</strong></div>
        </div>
        <div class="row">
          <div class="kpi">RAM: <strong id="sys-ram">‚Äî</strong></div>
          <div class="kpi">CPU ¬∞C: <strong id="sys-cpu">‚Äî</strong></div>
        </div>
      </div>

      <!-- LAN devices -->
      <div class="card span-6">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <h2>LAN Devices (MikroTik DHCP leases)</h2>
          <span id="lan-badge" class="badge" style="display:none"></span>
        </div>
        <table class="table" id="lan-table">
          <thead><tr><th>IP</th><th>MAC</th><th>Hostname</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Weather -->
      <div class="card span-3">
        <h2>Weather</h2>
        <form onsubmit="event.preventDefault(); fetchWeather();">
          <input id="city-input" type="text" class="kpi" value="Tirana" placeholder="City" style="flex:1;border-radius:8px;padding:8px;border:1px solid var(--border);background:#0c0e16;color:var(--text)">
          <div style="margin-top:8px"><button type="button" onclick="fetchWeather()">Update</button></div>
        </form>
        <div class="row">
          <div class="kpi">City: <strong id="wx-city">‚Äî</strong></div>
          <div class="kpi">Temp: <strong id="wx-temp">‚Äî</strong>¬∞C</div>
          <div class="kpi">Wind: <strong id="wx-wind">‚Äî</strong> m/s</div>
          <div class="kpi">Code: <strong id="wx-code">‚Äî</strong></div>
        </div>
      </div>

      <!-- Tunnel -->
      <div class="card span-3">
        <h2>Cloudflare Tunnel</h2>
        <div class="row"><div class="kpi">Status: <strong id="tun-status">‚Äî</strong></div></div>
        <pre id="cmd-output">‚Äî</pre>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button onclick="runCmd('tunnel-status')">Status</button>
          <button onclick="runCmd('tunnel-start')">Start</button>
          <button onclick="runCmd('tunnel-stop')">Stop</button>
          <button onclick="runCmd('update')">Update pkgs</button>
          <button onclick="runCmd('wifi-scan')">Wi‚ÄëFi Scan</button>
        </div>
      </div>

      <div class="card span-12">
        <h2>Status</h2>
        <div class="sub" id="status-line">Ready.</div>
      </div>
    </section>

    <footer>¬© <span id="year"></span> Termux Dashboard</footer>
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Battery & Wi‚ÄëFi
    async function updateSystemInfo(){
      try{
        const b=await fetch('/api/battery').then(r=>r.json());
        const pct=Math.max(0,Math.min(100,b.percentage ?? b.level ?? 0));
        document.getElementById('battery-percent').textContent=pct+'%';
        document.getElementById('charging-status').textContent=(b.status==='CHARGING'||b.plugged)?'‚ö° Charging':'On Battery';
        document.getElementById('bat-voltage').textContent=b.voltage ?? '‚Äî';
        document.getElementById('bat-temp').textContent=b.temperature ?? '‚Äî';
        document.getElementById('bat-health').textContent=b.health ?? '‚Äî';
      }catch{}
      try{
        const w=await fetch('/api/wifi').then(r=>r.json());
        const rssi=w.rssi ?? w.rssi_dbm ?? -90;
        let bars=1;if(rssi>-67)bars=4;else if(rssi>-70)bars=3;else if(rssi>-80)bars=2;
        document.querySelectorAll('.wifi-bar').forEach((bar,i)=>bar.style.opacity=(i<bars)?'1':'.3');
        document.getElementById('wifi-status').textContent=bars>=3?'Strong':(bars===2?'Fair':'Weak');
        document.getElementById('wifi-ssid').textContent=w.ssid||'‚Äî';
        document.getElementById('wifi-ip').textContent=w.ip||w.ip_address||'‚Äî';
        document.getElementById('wifi-rssi').textContent=rssi;
      }catch{}
    }
    setInterval(updateSystemInfo,5000); window.addEventListener('DOMContentLoaded',updateSystemInfo);

    // System
    async function refreshSystem(){
      try{
        const s=await fetch('/api/system').then(r=>r.json());
        document.getElementById('sys-uptime').textContent=s.uptime||'‚Äî';
        document.getElementById('sys-load').textContent=(s.loadavg||[]).join(', ')||'‚Äî';
        if(s.mem){
          const used=Math.max(0,(s.mem.total-s.mem.free-(s.mem.buffers||0)-(s.mem.cached||0)));
          document.getElementById('sys-ram').textContent=`${(used/1024).toFixed(0)} / ${(s.mem.total/1024).toFixed(0)} MB`;
        }
        const cpu=Array.isArray(s.thermal)&&s.thermal.length?s.thermal[0].temperature:null;
        document.getElementById('sys-cpu').textContent=cpu ?? '‚Äî';
      }catch{}
    }
    setInterval(refreshSystem,8000); window.addEventListener('DOMContentLoaded',refreshSystem);

    // Net chart
    const labels=[],rxData=[],txData=[]; let last=null;
    const ctx=document.getElementById('net-chart').getContext('2d');
    const netChart=new Chart(ctx,{type:'line',data:{labels,datasets:[
      {label:'RX kB/s',data:rxData,borderColor:'#22d3ee',backgroundColor:'rgba(34,211,238,.08)',tension:.25,fill:true},
      {label:'TX kB/s',data:txData,borderColor:'#4f6af5',backgroundColor:'rgba(79,106,245,.06)',tension:.25,fill:true},
    ]},options:{responsive:true,plugins:{legend:{labels:{color:'#e7e9f3'}}},scales:{x:{ticks:{color:'#a7acc0'}},y:{ticks:{color:'#a7acc0'}}}}});
    async function pollNet(){
      try{
        const n=await fetch('/api/network').then(r=>r.json());
        if(last){
          const dt=(n.ts-last.ts)/1000;
          const rx=dt>0?(n.rx-last.rx)/1024/dt:0;
          const tx=dt>0?(n.tx-last.tx)/1024/dt:0;
          const ts=new Date().toLocaleTimeString([], {hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
          labels.push(ts); rxData.push(Math.max(0,rx)); txData.push(Math.max(0,tx));
          if(labels.length>30){labels.shift();rxData.shift();txData.shift();}
          netChart.update();
        }
        last=n;
      }catch{}
    }
    setInterval(pollNet,3000); window.addEventListener('DOMContentLoaded',pollNet);

    // Weather
    async function geocodeCity(name){const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1`);const j=await r.json();if(!j.results||!j.results.length)throw new Error('City not found');const c=j.results[0];return {name:c.name,country:c.country,lat:c.latitude,lon:c.longitude};}
    async function getWeather(lat,lon){const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);const j=await r.json();return j.current_weather;}
    async function fetchWeather(){const name=(document.getElementById('city-input').value||'Tirana').trim();const status=document.getElementById('status-line');status.textContent=`Fetching weather for ${name}‚Ä¶`;try{const g=await geocodeCity(name);const wx=await getWeather(g.lat,g.lon);document.getElementById('wx-city').textContent=`${g.name}, ${g.country}`;document.getElementById('wx-temp').textContent=wx.temperature;document.getElementById('wx-wind').textContent=wx.windspeed;document.getElementById('wx-code').textContent=wx.weathercode;status.textContent=`Updated weather for ${g.name}.`;}catch{status.textContent='Weather update failed.';}}
    window.addEventListener('DOMContentLoaded',fetchWeather);

    // LAN table with error badge
    async function refreshLAN(){
      const badge=document.getElementById('lan-badge');
      const body=document.querySelector('#lan-table tbody');
      try{
        const data=await fetch('/api/lan').then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
        badge.style.display='none';
        body.innerHTML='';
        (data||[]).forEach(d=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${d.ip||''}</td><td>${d.mac||''}</td><td>${d.hostname||''}</td><td>${d.status||''}</td>`;
          body.appendChild(tr);
        });
        if(!data || !data.length){
          const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="4" class="sub">No leases returned.</td>`; body.appendChild(tr);
        }
      }catch(e){
        badge.textContent='Router offline';
        badge.className='badge bad';
        badge.style.display='inline-block';
        body.innerHTML=`<tr><td colspan="4" class="sub">Could not fetch leases (see server log).</td></tr>`;
      }
    }
    setInterval(refreshLAN,15000); window.addEventListener('DOMContentLoaded',refreshLAN);

    // Tunnel controls
    async function refreshTunnel(){try{const t=await fetch('/api/tunnel').then(r=>r.json());document.getElementById('tun-status').textContent=t.status||'‚Äî';}catch{}}
    setInterval(refreshTunnel,8000); window.addEventListener('DOMContentLoaded',refreshTunnel);
    async function runCmd(cmd){
      const out=document.getElementById('cmd-output'); out.textContent='Running‚Ä¶';
      try{const r=await fetch('/api/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cmd})}).then(r=>r.json());
        out.textContent=(r.stdout||r.stderr||JSON.stringify(r)); refreshTunnel();
      }catch{out.textContent='Command failed';}
    }
  </script>
</body>
</html>
